name: Deploy React App

# 触发条件：当 main 分支有 push 或 pull request 时
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 获取仓库代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ 安装 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ 安装 PNPM 包管理器
      - name: Install PNPM
        run: npm install -g pnpm

      # 4️⃣ 安装依赖
      - name: Install dependencies
        run: pnpm install

      # 5️⃣ 构建项目（在 Runner 上生成 dist）
      - name: Build project
        run: pnpm run build

      # 6️⃣ 上传 dist 到服务器
      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'dist/*' # 上传 dist 文件夹内容
          target: '/www/wwwroot/bill/views/' # 服务器目标路径

      # 7️⃣ 可选：清理服务器旧文件（如果 scp 不能覆盖）
      - name: Clean server target directory
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            rm -rf /www/wwwroot/bill/views/*
